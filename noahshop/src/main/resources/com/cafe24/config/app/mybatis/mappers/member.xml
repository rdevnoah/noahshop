<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="member">
	<insert id="insert" parameterType="membervo">
   		<![CDATA[
		insert into member 
		values(nextval('member_no_seq')
				, encode(encrypt(convert_to(#{id },'utf8'),convert_to(#{key },'utf8'), 'aes'),'hex')
				, #{password }
				, encode(encrypt(convert_to(#{name },'utf8'),convert_to(#{key },'utf8'), 'aes'),'hex')
				, encode(encrypt(convert_to(#{tel },'utf8'),convert_to(#{key },'utf8'), 'aes'),'hex')
				, encode(encrypt(convert_to(#{address },'utf8'),convert_to(#{key },'utf8'), 'aes'),'hex')
				, encode(encrypt(convert_to(#{email },'utf8'),convert_to(#{key },'utf8'), 'aes'),'hex')
				, now()
				, 'USER')
		]]>
		<selectKey resultType="long" keyProperty="no" order="AFTER">
			select currval('member_no_seq')
		</selectKey>
		
	</insert>
	
	<delete id="deleteAll">
		<![CDATA[
			delete from member
		]]>
	</delete>
	
	<delete id="deleteAllKey">
		<![CDATA[
			delete from key
		]]>
	</delete>
	
	<insert id="insertKey" parameterType="map">
	   	<![CDATA[
		insert into key(member_no, key)
		values(#{member.no }, #{key })
		]]>
	</insert>
	
	<select id="checkId" parameterType="string" resultType="string">
		<![CDATA[
		select id 
		from (select convert_from(decrypt(decode(m.id,'hex'), convert_to(k.key, 'utf8'),'aes'),'utf8') as id 
				from member m, key k 
				where m.no = k.member_no) a
		where id=#{id }
		]]>
	</select>
	
	<select id="getMemberByNo" parameterType="map" resultType="membervo">
		<![CDATA[
			select no
			, convert_from(decrypt(decode(id,'hex'), convert_to(#{key }, 'utf8'),'aes'),'utf8') as id
			, password
			, convert_from(decrypt(decode(name,'hex'), convert_to(#{key }, 'utf8'),'aes'),'utf8') as name
			, convert_from(decrypt(decode(tel,'hex'), convert_to(#{key }, 'utf8'),'aes'),'utf8') as tel
			, convert_from(decrypt(decode(address,'hex'), convert_to(#{key }, 'utf8'),'aes'),'utf8') as address
			, convert_from(decrypt(decode(email,'hex'), convert_to(#{key }, 'utf8'),'aes'),'utf8') as email
			, join_date as joinDate
			, role
			from member where no=#{no }
		]]>
	</select>
	
	<select id="getKeyByNo" parameterType="long" resultType="string">
		<![CDATA[
			select key from key where member_no=#{no }
		]]>
	</select>


	<select id="getOrderListById" parameterType="long" resultType="ordervo">
		select o.no, o.order_code as orderCode, o.address, o.payment, o.price, o.status, d.status as deliveryStatus
		from "order" o, delivery d
		where o.no=d.no and o.member_no=#{no }
	</select>

</mapper>
